@model Tuple<PMS.Models.Database.Job, PMS.Models.Database.JobDate, List<PMS.Models.Database.JobDateUser>, PMS.Models.Database.JobCharge>

@{
    ViewBag.Title = "Detail";
    if (ViewBag.StudioRoleID != null)
    {
        Layout = "~/Views/Shared/_LayoutStudioManage.cshtml";
    }
}

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.10.23/b-1.6.5/fc-3.3.2/fh-3.1.7/r-2.2.6/rg-1.1.2/sc-2.0.3/sb-1.0.1/sp-1.2.2/sl-1.3.1/datatables.min.css" />

<h2>Job's Detail</h2>
<div style="padding:10px">
    <a href="/@ViewBag.StudioUrl/job/paymentview/@Model.Item1.id" class="btn btn-primary">Open Invoice/Payment Menu</a>
</div>

<div class="container" style="font-size:16px">
    <div class="row">
        <div class="col-lg-6">
            <div class="card h-100" style="padding:15px">
                <div class="card-header">
                    <h4>Job's Information</h4>
                </div>
                <div class="card-body">
                    <dl class="dl-horizontal">
                        <dt>
                            Date Issued
                        </dt>

                        <dd>
                            @Model.Item1.DateCreated.ToString("dd/MM/yyyy hh:mm tt")
                        </dd>

                        <dt>
                            Payment Status
                        </dt>

                        <dd>
                            @Html.DisplayFor(model => model.Item1.paymentstatus)
                        </dd>

                        <dt>
                            Status
                        </dt>

                        <dd>
                            @Html.DisplayFor(model => model.Item1.JobStatu.name)
                        </dd>

                        <dt>
                            Package Name
                        </dt>

                        <dd>
                            @Html.DisplayFor(model => model.Item1.Package.name)
                        </dd>

                        <dt>
                            Client's Email
                        </dt>

                        <dd>
                            @Html.DisplayFor(model => model.Item1.User.email)
                        </dd>
                    </dl>
                </div>

                <div class="card-footer">
                    @if (ViewBag.StudioRoleID == 1)
                    {
                        <button type="button" class="btn btn-info btn-block" data-toggle="modal" data-target="#statusModal">Update</button>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100" style="padding:15px;">
                <div class="card-header">
                    <h4>Job's Date Information</h4>
                </div>
                <div class="card-body">
                    @if (Model.Item2 != null)
                    {
                        <dl class="dl-horizontal">
                            <dt>
                                Session Date & Time
                            </dt>

                            <dd>
                                @Model.Item2.jobdate1.ToString("dd/MM/yyyy hh:mm tt")
                            </dd>

                            <dt>
                                Photoshoot Location
                            </dt>

                            <dd>
                                @Html.DisplayFor(model => model.Item2.location)
                            </dd>

                            <dt>
                                Session Description
                            </dt>

                            @if (!string.IsNullOrWhiteSpace(Model.Item2.description))
                            {
                                <dd>@Html.DisplayFor(model => model.Item2.description)</dd>
                            }
                            else
                            {
                                <dd>-</dd>
                            }

                        </dl>
                    }
                    else
                    {
                        <h5>No Data Yet!</h5>
                    }
                </div>

                <div class="card-footer">
                    @if (ViewBag.StudioRoleID == 1)
                    {
                        <button type="button" class="btn btn-info btn-block" data-toggle="modal" data-target="#dateModal">Update</button>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card h-100" style="padding:15px">
                <div class="card-header">
                    <h4>Assigned Staff</h4>
                </div>
                <div class="card-body">
                    @if (Model.Item3.Count() != 0)
                    {
                        <table id="jduTable" class="table table-striped table-bordered w-100">
                            <thead>
                                <tr>
                                    <th>Staff</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th></th>
                                </tr>
                            </thead>
                        </table>
                    }
                    else
                    {
                        <h5>No Data Yet!</h5>
                    }
                </div>

                <div class="card-footer">
                    @if (ViewBag.StudioRoleID == 1)
                    {
                        <button type="button" class="btn btn-info btn-block" data-toggle="modal" data-target="#staffModal">Assign Staff</button>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100" style="padding:15px">
                <div class="card-header">
                    <h4>Job's Service Charges</h4>
                </div>
                <div class="card-body">
                    @if (Model.Item4 != null)
                    {
                        <table id="jobChargeTable" class="table table-striped table-bordered w-100">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th></th>
                                </tr>
                            </thead>
                        </table>
                    }
                    else
                    {
                        <h5>No Data Yet!</h5>
                    }
                </div>

                <div class="card-footer">
                    @if (ViewBag.StudioRoleID == 1)
                    {
                        <button type="button" class="btn btn-info btn-block" data-toggle="modal" data-target="#jobChargeModal">Add Service Charge</button>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Section -->
<div class="modal fade" id="statusModal" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <h4>Update Job</h4>
                        <hr />
                        <form action="~/@ViewBag.StudioUrl/job/changestatus" method="post">
                            @Html.AntiForgeryToken()

                            <input type="hidden" value="@Model.Item1.id" name="id" />

                            <div class="form-group">
                                <select title="Status" name="jsid" id="jobStatus" class="form-control"></select>
                            </div>
                            <div class="form-group">
                                <select title="Package" name="pid" id="packages" class="form-control"></select>
                            </div>

                            <div class="form-group">
                                <button type="submit" class="btn btn-info">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
<div class="modal fade" id="dateModal" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-body">
                @if (Model.Item2 == null)
                {
                    <h5>Please determine the date for the photoshoot session before you can proceed to assign staff/photographer</h5>
                }
                else
                {
                    <div class="card">
                        <div class="card-body">
                            <h4>Update Job Description</h4>
                            <hr />
                            <form action="~/@ViewBag.StudioUrl/job/changedate" method="post">
                                @Html.AntiForgeryToken()

                                @if (Model.Item2 != null)
                                {
                                    @Html.HiddenFor(x => x.Item2.id, new { @Value = Model.Item2.id });
                                }
                                @Html.HiddenFor(x => x.Item2.jobid, new { @Value = Model.Item1.id })
                                <div class="form-group">
                                    <input type="date" name="jobdate" class="form-control" value="@Model.Item2.jobdate1.ToString("yyyy-MM-dd")" />
                                </div>
                                <div class="form-group">
                                    <input type="time" name="jobtime" class="form-control" value="@Model.Item2.jobdate1.TimeOfDay" />
                                </div>
                                <div class="form-group">
                                    @Html.TextBoxFor(x => x.Item2.description, new { @class = "form-control", type = "text", placeholder = "Description..." })
                                </div>
                                <div class="form-group">
                                    @Html.TextBoxFor(x => x.Item2.location, new { @class = "form-control", type = "text", placeholder = "Location..." })
                                </div>
                                <div class="form-group">
                                    <select title="Status" name="jsid" id="jobDateStatus" class="form-control"></select>
                                </div>

                                <div class="form-group">
                                    <button type="submit" class="btn btn-info">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
<div class="modal fade" id="staffModal" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <h4>Search for staff to assign</h4>
                        <table id="adminTable" class="table table-striped table-bordered w-100">
                            <thead>
                                <tr>
                                    <th>Sort by Role</th>
                                    <th></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
<div class="modal fade" id="jobChargeModal" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <h4>Add Charge to Session</h4>
                        <hr />
                        <form action="~/@ViewBag.StudioUrl/job/jobcharge" method="post">
                            @Html.AntiForgeryToken()

                            @Html.HiddenFor(x => x.Item4.jobid, new { @Value = Model.Item1.id })
                            <div class="form-group">
                                <select name="cid" class="form-control" id="listCharge"></select>
                            </div>
                            <div class="form-group">
                                @Html.TextBoxFor(x => x.Item4.amount, new { @class = "form-control", placeholder = "Amount...", @Value = "" })
                            </div>
                            <div class="form-group">
                                @Html.TextBoxFor(x => x.Item4.remarks, new { @class = "form-control", placeholder = "Remarks...", @Value = "" })
                            </div>

                            <div class="form-group">
                                <button type="submit" class="btn btn-info">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
<!-- End Modal Section -->


@section Scripts {
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.10.23/b-1.6.5/fc-3.3.2/fh-3.1.7/r-2.2.6/rg-1.1.2/sc-2.0.3/sb-1.0.1/sp-1.2.2/sl-1.3.1/datatables.min.js"></script>
    <script>
    $.ajaxSetup({
        headers: { 'StudioCredential': '@ViewBag.StudioID' }
    });
        var table;
        var jctable;
        var jobstatus;
        var packages;
        var charges;
        $(function () {
            jctable = $("#jduTable").DataTable(
                {
                    serverSide: false,
                    ajax: {
                        type: "GET",
                        url: "/api/system/loadjobstaff/@Model.Item2.id",
                        dataSrc: ''
                    },
                    bLengthChange: true,
                    paging: false,
                    searchPlaceholder: "Search User",
                    search: true,
                    bSort: true,
                    info: false,
                    processing: true,
                    columns: [
                        { data: 'name', autoWidth: true },
                        { data: 'email', autoWidth: true },
                        { data: 'phone', autoWidth: true },
                        { data: 'id', render: function (data, type, row) { return `@if (ViewBag.StudioRoleID != null) { <a href="/@ViewBag.StudioUrl/job/deletejobstaff/${data}">Delete</a> }` }, autoWidth: true }
                    ]
                }
            );
        });
        $(function () {
            jctable = $("#jobChargeTable").DataTable(
                {
                    serverSide: false,
                    ajax: {
                        type: "GET",
                        url: "/api/system/loadjobcharges/@Model.Item1.id",
                        dataSrc: ''
                    },
                    bLengthChange: true,
                    paging: false,
                    searchPlaceholder: "Search User",
                    search: true,
                    bSort: true,
                    info: false,
                    processing: true,
                    columns: [
                        { data: 'remarks', autoWidth: true },
                        { data: 'amount', autoWidth: true },
                        { data: 'id', render: function (data, type, row) { return `@if (ViewBag.StudioRoleID != null) { <a href="/@ViewBag.StudioUrl/job/editjobcharge/${data}">Edit</a> <span>|</span> <a href="/@ViewBag.StudioUrl/job/deletejobcharge/${data}">Delete</a> }` }, autoWidth: true }
                    ]
                }
            );
        });
        $(function () {
            table = $("#adminTable").DataTable(
                {
                    serverSide: false,
                    ajax: {
                        type: "GET",
                        url: "/systemapi/studioroles/getRoleList",
                        dataSrc: ''
                    },
                    bLengthChange: true,
                    paging: false,
                    searchPlaceholder: "Search User",
                    search: true,
                    bSort: true,
                    info: false,
                    processing: true,
                    columns: [
                        {
                            data: 'StudioRole', render: function (data, type, row) {
                                return `
                                            <h5>${row.name}</h5>
                                            <p class="font-weight-light">${row.StudioRole}</p>
                                        ` }, "autoWidth": true
                        },
                        {
                            data: 'userid', render: function (data, type, row) {
                                return `@if (Model.Item2 != null) {
                                        <a href="/@ViewBag.StudioUrl/Job/assignstaff/${data}?jdid=@Model.Item2.id" class="btn btn-secondary">Assign</a>
                                    }` }, width: "10%"
                        }
                    ]
                }
            );
        });
        $(function () {
            $.ajax({
                type: "GET",
                url: "/api/system/loadJobStatus",
                dataSrc: '',
                success: function (data) {
                    $.each(data, function (i, obj) {
                        if (obj.id === @Model.Item1.jobstatusid) {
                            jobstatus = `<option value='${obj.id}' selected>${obj.name}</option>`
                        }
                        else {
                            jobstatus = `<option value='${obj.id}'>${obj.name}</option>`
                        }

                        $("#jobStatus").append(jobstatus)
                        $("#jobDateStatus").append(jobstatus)
                    })
                }
            })
        });
        $(function () {
            $.ajax({
                type: "GET",
                url: "/api/system/loadpackages/@ViewBag.StudioID",
                dataSrc: '',
                success: function (data) {
                    $.each(data, function (i, obj) {
                        if (obj.id === @Model.Item1.packageid) {
                            packages = `<option value='${obj.id}' selected>${obj.name}</option>`
                        }
                        else {
                            packages = `<option value='${obj.id}'>${obj.name}</option>`
                        }

                        $("#packages").append(packages)
                    })
                }
            })
        });
        $(function () {
            $.ajax({
                type: "GET",
                url: "/api/system/loadcharges/@ViewBag.StudioID",
                dataSrc: '',
                success: function (data) {
                    $.each(data, function (i, obj) {
                        charges = `<option value='${obj.id}'>${obj.Name}</option>`
                        $("#listCharge").append(charges)
                    })
                }
            })
        });
    </script>
}
