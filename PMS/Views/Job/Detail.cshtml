@model Tuple<PMS.Models.Database.Job, PMS.Models.Database.JobDate, List<PMS.Models.Database.JobDateUser>, PMS.Models.Database.JobCharge>

@{
    ViewBag.Title = "Detail";
    if (ViewBag.StudioRoleID != null)
    {
        Layout = "~/Views/Shared/_LayoutStudioManage.cshtml";
    }
}

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.10.23/b-1.6.5/fc-3.3.2/fh-3.1.7/r-2.2.6/rg-1.1.2/sc-2.0.3/sb-1.0.1/sp-1.2.2/sl-1.3.1/datatables.min.css" />
<style>
    a:hover, a:focus {
        text-decoration: none;
        outline: none;
    }

    #accordion .panel {
        border: none;
        border-radius: 3px;
        box-shadow: none;
        margin-bottom: 15px;
    }

    #accordion .panel-heading {
        padding: 0;
        border: none;
        border-radius: 3px;
    }

    #accordion .panel-title a {
        display: block;
        padding: 12px 15px;
        background: #fff;
        font-size: 18px;
        font-weight: bold;
        color: #f81ac1;
        border: 1px solid #ececec;
        box-shadow: 0 0 10px rgba(0,0,0,.05);
        position: relative;
        transition: all 0.5s ease 0s;
    }

        #accordion .panel-title a.collapsed {
            box-shadow: none;
            color: #676767;
        }

            #accordion .panel-title a:before,
            #accordion .panel-title a.collapsed:before {
                content: "\f067";
                font-family: "Font Awesome 5 Free";
                width: 25px;
                height: 25px;
                line-height: 28px;
                font-size: 15px;
                font-weight: 900;
                color: #f81ac1;
                text-align: center;
                position: absolute;
                top: 8px;
                right: 15px;
                transform: rotate(135deg);
                transition: all 0.3s ease 0s;
            }

            #accordion .panel-title a.collapsed:before {
                color: #676767;
                transform: rotate(0);
            }

        #accordion .panel-title a:after {
            content: "";
            width: 1px;
            height: 100%;
            background: #ececec;
            position: absolute;
            top: 0;
            right: 55px;
        }

    #accordion .panel-body {
        padding: 10px 15px 15px;
        border: none;
        font-size: 15px;
        color: #615f5f;
        line-height: 27px;
    }
</style>

<div class="container" style="font-size:16px">
    <div class="card">
        <div class="card-header">
            <h4 class="float-left"><i class="mdi mdi-briefcase-clock"></i> Job's Detail</h4>
            <a href="/@ViewBag.StudioUrl/job/paymentview/@Model.Item1.id" class="btn btn-primary float-right">Open Invoice/Payment Menu</a>
        </div>
        <div class="card-body" style="padding:30px">
            <div class="row">
                <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true" style="width:100%">
                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="headingOne">
                            <h4 class="panel-title">
                                <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Job's Information
                                </a>
                            </h4>
                        </div>
                        <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
                            <div class="panel-body">
                                <div class="card" style="padding:10px">
                                    <dl class="dl-horizontal">
                                        <dt>
                                            Date Issued
                                        </dt>

                                        <dd style="margin-left:5px">
                                            @Model.Item1.DateCreated.ToString("dd/MM/yyyy hh:mm tt")
                                        </dd>

                                        <dt>
                                            Payment Status
                                        </dt>

                                        <dd style="margin-left:5px">
                                            @if (string.IsNullOrWhiteSpace(Model.Item1.paymentstatus))
                                            { <span>-</span> }
                                            else
                                            { @Html.DisplayFor(model => model.Item1.paymentstatus)}
                                        </dd>

                                        <dt>
                                            Status
                                        </dt>

                                        <dd style="margin-left:5px">
                                            @if (Model.Item1.JobStatu.name == "Pending")
                                            {
                                                <span style="background-color:orange;padding:5px;border-radius:10px;color:white">@Model.Item1.JobStatu.name</span>
                                            }
                                            else if (Model.Item1.JobStatu.name == "Pending Deposit")
                                            {
                                                <span style="background-color:red;padding:5px;border-radius:10px;color:white">@Model.Item1.JobStatu.name</span>
                                            }
                                            else if (Model.Item1.JobStatu.name == "Quote")
                                            {
                                                <span style="background-color:blue;padding:5px;border-radius:10px;color:white">@Model.Item1.JobStatu.name</span>
                                            }
                                            else if (Model.Item1.JobStatu.name == "Completed")
                                            {
                                                <span style="background-color:green;padding:5px;border-radius:10px;color:white">@Model.Item1.JobStatu.name</span>
                                            }
                                            else
                                            {
                                                <span style="background-color:gray;padding:5px;border-radius:10px;color:white">@Model.Item1.JobStatu.name</span>
                                            }
                                        </dd>

                                        <dt>
                                            Package Name
                                        </dt>

                                        <dd style="margin-left:5px">
                                            @Html.DisplayFor(model => model.Item1.Package.name)
                                        </dd>

                                        <dt>
                                            Client's Email
                                        </dt>

                                        <dd style="margin-left:5px">
                                            @Html.DisplayFor(model => model.Item1.User.email)
                                        </dd>
                                    </dl>
                                    @if (ViewBag.StudioRoleID == 1)
                                    {
                                        <button type="button" class="btn btn-info btn-block" data-toggle="modal" data-target="#statusModal">Update</button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="headingTwo">
                            <h4 class="panel-title">
                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    Job's Date Information
                                </a>
                            </h4>
                        </div>
                        <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
                            <div class="panel-body">
                                <div class="card" style="padding:10px">
                                    @if (Model.Item2 != null)
                                    {
                                        <dl class="dl-horizontal">
                                            <dt>
                                                Session Date & Time
                                            </dt>

                                            <dd style="margin-left:5px">
                                                @Model.Item2.jobdate1.ToString("dd/MM/yyyy hh:mm tt")
                                            </dd>

                                            <dt>
                                                Photoshoot Location
                                            </dt>

                                            <dd style="margin-left:5px">
                                                @Html.DisplayFor(model => model.Item2.location)
                                            </dd>

                                            <dt>
                                                Session Description
                                            </dt>

                                            @if (!string.IsNullOrWhiteSpace(Model.Item2.description))
                                            {
                                                <dd style="margin-left:5px">@Html.DisplayFor(model => model.Item2.description)</dd>
                                            }
                                            else
                                            {
                                                <dd style="margin-left:5px">-</dd>
                                            }

                                        </dl>
                                    }
                                    else
                                    {
                                        <h5>No Data Yet!</h5>
                                    }
                                    @if (ViewBag.StudioRoleID == 1)
                                    {
                                        <button type="button" class="btn btn-info btn-block" data-toggle="modal" data-target="#dateModal">Update</button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="headingThree">
                            <h4 class="panel-title">
                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                    Assigned Staff
                                </a>
                            </h4>
                        </div>
                        <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
                            <div class="panel-body">
                                <div class="card" style="padding:10px">
                                    @if (Model.Item3.Count() != 0)
                                    {
                                        <table id="jduTable" class="table table-striped table-bordered w-100">
                                            <thead>
                                                <tr>
                                                    <th>Staff</th>
                                                    <th>Email</th>
                                                    <th>Phone</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                        </table>
                                    }
                                    else
                                    {
                                        <h5>No Data Yet!</h5>
                                    }
                                    @if (ViewBag.StudioRoleID == 1)
                                    {
                                        <button type="button" class="btn btn-info btn-block" data-toggle="modal" data-target="#staffModal">Assign Staff</button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="headingFour">
                            <h4 class="panel-title">
                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                    Service Charges
                                </a>
                            </h4>
                        </div>
                        <div id="collapseFour" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingFour">
                            <div class="panel-body">
                                <div class="card" style="padding:10px">
                                    @if (Model.Item4 != null)
                                    {
                                        <table id="jobChargeTable" class="table table-striped table-bordered w-100">
                                            <thead>
                                                <tr>
                                                    <th>Description</th>
                                                    <th>Amount</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                        </table>
                                    }
                                    else
                                    {
                                        <h5>No Data Yet!</h5>
                                    }
                                    @if (ViewBag.StudioRoleID == 1)
                                    {
                                        <button type="button" class="btn btn-info btn-block" data-toggle="modal" data-target="#jobChargeModal">Add Service Charge</button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Section -->
<div class="modal fade" id="statusModal" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <h4>Update Job</h4>
                        <hr />
                        <form action="~/@ViewBag.StudioUrl/job/changestatus" method="post">
                            @Html.AntiForgeryToken()

                            <input type="hidden" value="@Model.Item1.id" name="id" />

                            <div class="form-group">
                                <select title="Status" name="jsid" id="jobStatus" class="form-control"></select>
                            </div>
                            <div class="form-group">
                                <select title="Package" name="pid" id="packages" class="form-control"></select>
                            </div>

                            <div class="form-group">
                                <button type="submit" class="btn btn-info">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
<div class="modal fade" id="dateModal" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-body">
                @if (Model.Item2 == null)
                {
                    <h5>Please determine the date for the photoshoot session before you can proceed to assign staff/photographer</h5>
                }
                else
                {
                    <div class="card">
                        <div class="card-body">
                            <h4>Update Job Description</h4>
                            <hr />
                            <form action="~/@ViewBag.StudioUrl/job/changedate" method="post">
                                @Html.AntiForgeryToken()

                                @if (Model.Item2 != null)
                                {
                                    @Html.HiddenFor(x => x.Item2.id, new { @Value = Model.Item2.id });
                                }
                                @Html.HiddenFor(x => x.Item2.jobid, new { @Value = Model.Item1.id })
                                <div class="form-group">
                                    <input type="date" name="jobdate" class="form-control" value="@Model.Item2.jobdate1.ToString("yyyy-MM-dd")" />
                                </div>
                                <div class="form-group">
                                    <input type="time" name="jobtime" class="form-control" value="@Model.Item2.jobdate1.TimeOfDay" />
                                </div>
                                <div class="form-group">
                                    @Html.TextBoxFor(x => x.Item2.description, new { @class = "form-control", type = "text", placeholder = "Description..." })
                                </div>
                                <div class="form-group">
                                    @Html.TextBoxFor(x => x.Item2.location, new { @class = "form-control", type = "text", placeholder = "Location..." })
                                </div>
                                <div class="form-group">
                                    <select title="Status" name="jsid" id="jobDateStatus" class="form-control"></select>
                                </div>

                                <div class="form-group">
                                    <button type="submit" class="btn btn-info">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
<div class="modal fade" id="staffModal" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <h4>Search for staff to assign</h4>
                        <table id="adminTable" class="table table-striped table-bordered w-100">
                            <thead>
                                <tr>
                                    <th>Sort by Role</th>
                                    <th></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
<div class="modal fade" id="jobChargeModal" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <h4>Add Charge to Session</h4>
                        <hr />
                        <form action="~/@ViewBag.StudioUrl/job/jobcharge" method="post">
                            @Html.AntiForgeryToken()

                            @Html.HiddenFor(x => x.Item4.jobid, new { @Value = Model.Item1.id })
                            <div class="form-group">
                                <select name="cid" class="form-control" id="listCharge"></select>
                            </div>
                            <div class="form-group">
                                @Html.TextBoxFor(x => x.Item4.amount, new { @class = "form-control", placeholder = "Amount...", @Value = "" })
                            </div>
                            <div class="form-group">
                                @Html.TextBoxFor(x => x.Item4.remarks, new { @class = "form-control", placeholder = "Remarks...", @Value = "" })
                            </div>

                            <div class="form-group">
                                <button type="submit" class="btn btn-info">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
<!-- End Modal Section -->


@section Scripts {
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.10.23/b-1.6.5/fc-3.3.2/fh-3.1.7/r-2.2.6/rg-1.1.2/sc-2.0.3/sb-1.0.1/sp-1.2.2/sl-1.3.1/datatables.min.js"></script>
    <script>
    $.ajaxSetup({
        headers: { 'StudioCredential': '@ViewBag.StudioID' }
    });
        var table;
        var jctable;
        var jobstatus;
        var packages;
        var charges;
        $(function () {
            jctable = $("#jduTable").DataTable(
                {
                    serverSide: false,
                    ajax: {
                        type: "GET",
                        url: "/api/system/loadjobstaff/@Model.Item2.id",
                        dataSrc: ''
                    },
                    bLengthChange: true,
                    paging: false,
                    searchPlaceholder: "Search User",
                    search: true,
                    bSort: true,
                    info: false,
                    processing: true,
                    columns: [
                        { data: 'name', autoWidth: true },
                        { data: 'email', autoWidth: true },
                        { data: 'phone', autoWidth: true },
                        { data: 'id', render: function (data, type, row) { return `@if (ViewBag.StudioRoleID != null) { <a href="/@ViewBag.StudioUrl/job/deletejobstaff/${data}">Delete</a> }` }, autoWidth: true }
                    ]
                }
            );
        });
        $(function () {
            jctable = $("#jobChargeTable").DataTable(
                {
                    serverSide: false,
                    ajax: {
                        type: "GET",
                        url: "/api/system/loadjobcharges/@Model.Item1.id",
                        dataSrc: ''
                    },
                    bLengthChange: true,
                    paging: false,
                    searchPlaceholder: "Search User",
                    search: true,
                    bSort: true,
                    info: false,
                    processing: true,
                    columns: [
                        { data: 'remarks', autoWidth: true },
                        { data: 'amount', autoWidth: true },
                        { data: 'id', render: function (data, type, row) { return `@if (ViewBag.StudioRoleID != null) { <a href="/@ViewBag.StudioUrl/job/editjobcharge/${data}">Edit</a> <span>|</span> <a href="/@ViewBag.StudioUrl/job/deletejobcharge/${data}">Delete</a> }` }, autoWidth: true }
                    ]
                }
            );
        });
        $(function () {
            table = $("#adminTable").DataTable(
                {
                    serverSide: false,
                    ajax: {
                        type: "GET",
                        url: "/systemapi/studioroles/getRoleList",
                        dataSrc: ''
                    },
                    bLengthChange: true,
                    paging: false,
                    searchPlaceholder: "Search User",
                    search: true,
                    bSort: true,
                    info: false,
                    processing: true,
                    columns: [
                        {
                            data: 'StudioRole', render: function (data, type, row) {
                                return `
                                            <h5>${row.name}</h5>
                                            <p class="font-weight-light">${row.StudioRole}</p>
                                        ` }, "autoWidth": true
                        },
                        {
                            data: 'userid', render: function (data, type, row) {
                                return `@if (Model.Item2 != null) {
                                        <a href="/@ViewBag.StudioUrl/Job/assignstaff/${data}?jdid=@Model.Item2.id" class="btn btn-secondary">Assign</a>
                                    }` }, width: "10%"
                        }
                    ]
                }
            );
        });
        $(function () {
            $.ajax({
                type: "GET",
                url: "/api/system/loadJobStatus",
                dataSrc: '',
                success: function (data) {
                    $.each(data, function (i, obj) {
                        if (obj.id === @Model.Item1.jobstatusid) {
                            jobstatus = `<option value='${obj.id}' selected>${obj.name}</option>`
                        }
                        else {
                            jobstatus = `<option value='${obj.id}'>${obj.name}</option>`
                        }

                        $("#jobStatus").append(jobstatus)
                        $("#jobDateStatus").append(jobstatus)
                    })
                }
            })
        });
        $(function () {
            $.ajax({
                type: "GET",
                url: "/api/system/loadpackages/@ViewBag.StudioID",
                dataSrc: '',
                success: function (data) {
                    $.each(data, function (i, obj) {
                        if (obj.id === @Model.Item1.packageid) {
                            packages = `<option value='${obj.id}' selected>${obj.name}</option>`
                        }
                        else {
                            packages = `<option value='${obj.id}'>${obj.name}</option>`
                        }

                        $("#packages").append(packages)
                    })
                }
            })
        });
        $(function () {
            $.ajax({
                type: "GET",
                url: "/api/system/loadcharges/@ViewBag.StudioID",
                dataSrc: '',
                success: function (data) {
                    $.each(data, function (i, obj) {
                        charges = `<option value='${obj.id}'>${obj.Name}</option>`
                        $("#listCharge").append(charges)
                    })
                }
            })
        });
    </script>
}
